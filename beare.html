<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Duck Clicker</title>
  <style>
    :root{
      --bg1:#7dd3fc; --bg2:#bae6fd;
      --card:#ffffffcc; --text:#0f172a; --muted:#475569;
      --shadow: 0 20px 60px rgba(2, 6, 23, .18);
      --radius: 22px; --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      min-height:100svh;
      display:grid;
      place-items:center;
      overflow:hidden;
      background: linear-gradient(180deg, var(--bg1), var(--bg2));
      padding:
        max(env(safe-area-inset-top), 10px)
        max(env(safe-area-inset-right), 10px)
        max(env(safe-area-inset-bottom), 10px)
        max(env(safe-area-inset-left), 10px);
    }

    .cloud{ position:absolute; width:220px; height:70px; background:#fff; border-radius:999px; opacity:.85;
      box-shadow: 0 14px 40px rgba(2, 6, 23, .08); animation: drift linear infinite; }
    .cloud::before,.cloud::after{ content:""; position:absolute; background:#fff; border-radius:999px; }
    .cloud::before{ width:90px; height:90px; left:20px; top:-35px; }
    .cloud::after{ width:120px; height:120px; left:80px; top:-55px; }
    @keyframes drift{ from{ transform: translateX(-320px);} to{ transform: translateX(calc(100vw + 320px)); } }

    .card{
      position:relative;
      width:min(560px, 96vw);
      padding:14px;
      border-radius: var(--radius);
      background: var(--card);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,.55);
      text-align:center;
    }
    h1{ margin:6px 0 4px; font-size: clamp(20px, 3.2vw, 28px); }
    .sub{ margin:0 0 10px; color: var(--muted); font-size: 13px; }

    .topbar{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 8px 0 10px;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:10px 12px; border-radius:999px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(15, 23, 42, .08);
      box-shadow: 0 10px 24px rgba(2,6,23,.08);
      font-weight: 900;
      white-space: nowrap;
    }
    .pill small{ font-weight:900; color: var(--muted); }

    /* energy bar */
    .energyBox{
      width:min(520px, 92vw);
      margin: 4px auto 10px;
      text-align:left;
    }
    .energyTop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      color: var(--muted);
      font-weight: 1000;
      font-size: 12px;
      margin-bottom: 6px;
    }
    .bar{
      width:100%;
      height:14px;
      border-radius:999px;
      background: rgba(15, 23, 42, .10);
      overflow:hidden;
      border: 1px solid rgba(15, 23, 42, .08);
    }
    .bar > div{
      height:100%;
      width:0%;
      border-radius:999px;
      transition: width .18s ease;
      background: var(--ok);
    }
    .energyHint{ margin-top:6px; font-size:12px; color: var(--muted); font-weight:900; }

    .duck-wrap{
      position:relative;
      display:grid;
      place-items:center;
      margin: 6px auto 6px;
      width:min(320px, 74vw);
      aspect-ratio: 1 / 1;
    }
    .duck-btn{
      width:100%; height:100%;
      border:none; background:transparent;
      cursor:pointer; padding:0;
      display:grid; place-items:center;
      user-select:none; -webkit-tap-highlight-color: transparent;
      transition: transform .08s ease;
    }
    .duck-btn:active{ transform: scale(.98); }
    .duck-btn:disabled{ opacity:.60; cursor:not-allowed; }
    .duck{
      width: 86%;
      max-width: 300px;
      filter: drop-shadow(0 18px 28px rgba(2,6,23,.22));
      transform-origin: 50% 70%;
    }
    .duck.red{ filter: drop-shadow(0 18px 28px rgba(2,6,23,.22)) hue-rotate(150deg) saturate(2.4); }
    .duck.green{ filter: drop-shadow(0 18px 28px rgba(2,6,23,.22)) hue-rotate(80deg) saturate(2.2); }

    .pop{ animation: pop .22s ease-out; }
    @keyframes pop{
      0%{ transform: translateY(0) rotate(0deg) scale(1); }
      40%{ transform: translateY(-10px) rotate(-2deg) scale(1.03); }
      100%{ transform: translateY(0) rotate(0deg) scale(1); }
    }
    .bubble{
      position:absolute; width:14px; height:14px; border-radius:999px;
      background: rgba(255,255,255,.85);
      box-shadow: inset 0 -2px 0 rgba(2,6,23,.06);
      animation: rise .9s ease-out forwards;
      pointer-events:none;
    }
    @keyframes rise{
      from{ transform: translateY(0) scale(.9); opacity: 1; }
      to{ transform: translateY(-90px) scale(1.35); opacity: 0; }
    }
    .hint{ margin-top:8px; font-size: 12px; color: var(--muted); }

    /* floating buttons */
    .float{
      position:fixed;
      right: max(env(safe-area-inset-right), 12px);
      top: 50%;
      transform: translateY(-50%);
      z-index: 50;
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:flex-end;
    }
    .fab{
      width:56px; height:56px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      background: rgba(15, 23, 42, .92);
      color:#fff;
      font-weight: 1000;
      box-shadow: 0 16px 40px rgba(2,6,23,.22);
    }
    .fab span{ display:block; font-size:10px; letter-spacing:.4px; margin-top:2px; opacity:.9; }

    /* modal */
    .modal-back{
      position:fixed; inset:0; z-index:100;
      background: rgba(2,6,23,.45);
      display:none;
      align-items:center; justify-content:center;
      padding: max(env(safe-area-inset-top), 10px) 10px max(env(safe-area-inset-bottom), 10px);
    }
    .modal-back.show{ display:flex; }
    .modal{
      width:min(620px, 96vw);
      background: rgba(255,255,255,.94);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 22px;
      box-shadow: 0 22px 70px rgba(2,6,23,.28);
      padding: 12px;
      text-align:center;
      max-height: 92svh;
      overflow:auto;
    }
    .modal h2{ margin:6px 0 6px; font-size: 18px; }
    .row{
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:flex-end; justify-content:center;
      margin-top: 10px;
    }
    label{
      display:block; font-weight: 1000; color: var(--muted);
      font-size: 12px; margin-bottom:6px; text-align:left;
    }
    input{
      width: 220px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.12);
      outline:none;
      font-weight: 1000;
      background: rgba(255,255,255,.95);
    }
    .btn{
      border:none; cursor:pointer; border-radius: 14px;
      padding: 10px 14px; font-weight: 1000;
      background: rgba(15, 23, 42, .92); color:#fff;
      box-shadow: 0 12px 30px rgba(2,6,23,.18);
    }
    .btn.secondary{
      background: rgba(255,255,255,.90); color: var(--text);
      border: 1px solid rgba(15, 23, 42, .10);
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .msg{ margin-top:10px; font-weight: 1000; font-size: 13px; color: var(--muted); }
    .msg.good{ color: var(--ok); }
    .msg.bad{ color: var(--bad); }

    /* flappy canvas */
    canvas{
      width: min(420px, 92vw);
      height: auto;
      border-radius: 18px;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(15, 23, 42, .10);
      box-shadow: 0 12px 30px rgba(2,6,23,.12);
      touch-action: manipulation;
      outline:none;
      margin-top: 10px;
    }
    .flhud{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      width:min(420px, 92vw); margin: 8px auto 0;
      color: var(--muted); font-weight:1000; font-size: 13px;
    }

    .shopCard{
      width:min(520px, 92vw);
      margin: 10px auto 0;
      background: rgba(255,255,255,.70);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 18px;
      padding: 12px;
      text-align:left;
      box-shadow: 0 10px 24px rgba(2,6,23,.10);
    }
    .shopTitle{ font-weight:1000; margin:0 0 8px; }
    .skinRow{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(15,23,42,.08);
      background: rgba(255,255,255,.75);
      margin-top: 8px;
    }
    .skinLeft{ display:flex; flex-direction:column; gap:2px; }
    .skinName{ font-weight:1000; }
    .skinDesc{ font-size:12px; color: var(--muted); font-weight:900; }
  </style>
</head>

<body>
  <div class="cloud" style="top:8vh; left:-260px; animation-duration: 42s;"></div>
  <div class="cloud" style="top:16vh; left:-360px; animation-duration: 55s; transform: scale(.9); opacity:.75;"></div>
  <div class="cloud" style="top:26vh; left:-420px; animation-duration: 48s; transform: scale(1.1); opacity:.8;"></div>

  <div class="card">
    <h1>–ö–ª–∏–∫–µ—Ä —É—Ç–æ—á–∫–∏ ü¶Ü</h1>
    <div class="sub">–ö–ª–∏–∫–∞–π –ø–æ —É—Ç–∫–µ ‚Üí –æ—á–∫–∏. –≠–Ω–µ—Ä–≥–∏—è —Ç—Ä–∞—Ç–∏—Ç—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.</div>

    <div class="topbar">
      <div class="pill">‚≠ê <span id="balance">0</span> <small>–æ—á–∫–∏</small></div>
      <div class="pill">üí• <span id="taps">0</span> <small>–∫–ª–∏–∫–∏</small></div>
      <div class="pill">‚ú® <span id="stars">0</span> <small>–∑–≤—ë–∑–¥—ã</small></div>
      <div class="pill">üé® <span id="skinLabel">–û–±—ã—á–Ω–∞—è</span></div>
    </div>

    <div class="energyBox">
      <div class="energyTop">
        <div>‚ö° –≠–Ω–µ—Ä–≥–∏—è: <span id="energyText">0</span>/<span id="energyMaxText">0</span></div>
        <div>‚àí<span id="costText">1</span> / –∫–ª–∏–∫ ¬∑ +<span id="regenText">1</span> / <span id="regenSecText">2</span>—Å</div>
      </div>
      <div class="bar"><div id="energyBar"></div></div>
      <div class="energyHint" id="energyHint">–ñ–º–∏ –Ω–∞ —É—Ç–∫—É üôÇ</div>
    </div>

    <div class="duck-wrap" id="arena">
      <button class="duck-btn" id="duckBtn" aria-label="–ö–ª–∏–∫ –ø–æ —É—Ç–æ—á–∫–µ">
        <img id="duckImg" class="duck" alt="–£—Ç–æ—á–∫–∞"
             src="https://commons.wikimedia.org/wiki/Special:FilePath/Rubber%20duck.svg"/>
      </button>
    </div>

    <div class="hint">–°–ø—Ä–∞–≤–∞: ‚ÇΩ (–ø–µ—Ä–µ–≤–æ–¥), üéÆ Flappy (—Å—Ç–∞–≤–∫–∞), üé® –°–∫–∏–Ω—ã.</div>
  </div>

  <!-- FLOAT BUTTONS -->
  <div class="float">
    <button class="fab" id="openRub" type="button">‚ÇΩ<span>–†—É–±–ª–∏</span></button>
    <button class="fab" id="openFlappy" type="button">üéÆ<span>Flappy</span></button>
    <button class="fab" id="openSkins" type="button">üé®<span>–°–∫–∏–Ω—ã</span></button>
  </div>

  <!-- RUB MODAL -->
  <div class="modal-back" id="rubBack">
    <div class="modal">
      <h2>–ü–µ—Ä–µ–≤–æ–¥ –≤ —Ä—É–±–ª–∏</h2>
      <div class="msg">–ö—É—Ä—Å: <b>1 –æ—á–∫–æ = 0.01 ‚ÇΩ</b></div>

      <div class="row">
        <div>
          <label>–¢–≤–æ–∏ –æ—á–∫–∏</label>
          <input id="rubPoints" type="text" readonly/>
        </div>
        <div>
          <label>–°—É–º–º–∞ ‚ÇΩ</label>
          <input id="rubSum" type="text" readonly/>
        </div>
      </div>

      <div class="row">
        <button class="btn" id="calcRub" type="button">–ü–æ—Å—á–∏—Ç–∞—Ç—å</button>
        <button class="btn secondary" id="closeRub" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- SKINS MODAL -->
  <div class="modal-back" id="skinsBack">
    <div class="modal">
      <h2>–°–∫–∏–Ω—ã (–∑–∞ ‚≠ê)</h2>
      <div class="msg">–ö—Ä–∞—Å–Ω–∞—è/–ó–µ–ª—ë–Ω–∞—è –º–µ–Ω—è—é—Ç –º–Ω–æ–∂–∏—Ç–µ–ª–∏ –∫–ª–∏–∫–æ–≤ –∏ Flappy.</div>

      <div class="shopCard">
        <div class="shopTitle">–î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫–∏–Ω—ã</div>

        <div class="skinRow">
          <div class="skinLeft">
            <div class="skinName">üî¥ –ö—Ä–∞—Å–Ω–∞—è</div>
            <div class="skinDesc">–ö–ª–∏–∫–µ—Ä: x2 ¬∑ Flappy: x2.5 ¬∑ –¶–µ–Ω–∞: 40‚≠ê</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn secondary" id="equipRed" type="button">–ù–∞–¥–µ—Ç—å</button>
            <button class="btn" id="buyRed" type="button">–ö—É–ø–∏—Ç—å 40‚≠ê</button>
          </div>
        </div>

        <div class="skinRow">
          <div class="skinLeft">
            <div class="skinName">üü¢ –ó–µ–ª—ë–Ω–∞—è</div>
            <div class="skinDesc">–ö–ª–∏–∫–µ—Ä: x3 ¬∑ Flappy: x3 ¬∑ –¶–µ–Ω–∞: 100‚≠ê</div>
          </div>
          <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button class="btn secondary" id="equipGreen" type="button">–ù–∞–¥–µ—Ç—å</button>
            <button class="btn" id="buyGreen" type="button">–ö—É–ø–∏—Ç—å 100‚≠ê</button>
          </div>
        </div>

        <div class="row" style="justify-content:space-between; align-items:center;">
          <div class="pill">‚ú® <span id="stars2">0</span> <small>–∑–≤—ë–∑–¥—ã</small></div>
          <button class="btn secondary" id="howBuyStars" type="button">–ö–∞–∫ –∫—É–ø–∏—Ç—å ‚≠ê</button>
        </div>

        <div class="msg" id="skinsMsg"></div>
      </div>

      <div class="row">
        <button class="btn secondary" id="closeSkins" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- FLAPPY MODAL -->
  <div class="modal-back" id="flBack">
    <div class="modal">
      <h2>Flappy Duck ‚Äî —Å—Ç–∞–≤–∫–∞</h2>
      <div class="msg" id="flInfo">
        –°—Ç–∞–≤–∫–∞ –æ—á–∫–∞–º–∏. –ü—Ä–æ–π–¥–∏ <b>40</b> ‚Üí –ø–æ–ª—É—á–∏—à—å –≤—ã–∏–≥—Ä—ã—à = —Å—Ç–∞–≤–∫–∞ √ó –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–∏–Ω–∞.
      </div>

      <div class="row">
        <div>
          <label>–°—Ç–∞–≤–∫–∞ (–æ—á–∫–∏)</label>
          <input id="stakeInp" type="number" min="1" step="1" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä 50"/>
        </div>
        <button class="btn" id="startFlappy" type="button">–ò–≥—Ä–∞—Ç—å</button>
        <button class="btn secondary" id="closeFlappy" type="button">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>

      <canvas id="cv" width="360" height="512"></canvas>

      <div class="flhud">
        <div>–°—á—ë—Ç: <span id="score">0</span>/40</div>
        <div>–°—Ç–∞–≤–∫–∞: <span id="stakeNow">0</span></div>
        <div>–ú–Ω–æ–∂–∏—Ç–µ–ª—å: <span id="flMultLabel">x2</span></div>
        <div>–°—Ç–∞—Ç—É—Å: <span id="status">–Ω–µ –∏–≥—Ä–∞–µ–º</span></div>
      </div>

      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="restartBtn" type="button">–†–µ—Å—Ç–∞—Ä—Ç</button>
      </div>

      <div class="msg" id="flMsg"></div>
    </div>
  </div>

<script>
  // ---------- STORAGE ----------
  const K_BAL = 'duck_balance';
  const K_TAPS = 'duck_taps';
  const K_STARS = 'duck_stars';
  const K_SKIN = 'duck_skin';
  const K_OWN_RED = 'duck_own_red';
  const K_OWN_GREEN = 'duck_own_green';
  const K_EN = 'duck_energy';

  const RUB_PER_POINT = 0.01;

  // energy
  const ENERGY_MAX = 100;
  const CLICK_COST = 1;
  const REGEN_AMOUNT = 1;
  const REGEN_EVERY_MS = 2000;

  // skins
  const SKINS = {
    normal: { label: '–û–±—ã—á–Ω–∞—è', tapMult: 1, flappyMult: 2.0, css: '' },
    red:    { label: '–ö—Ä–∞—Å–Ω–∞—è', tapMult: 2, flappyMult: 2.5, css: 'red' },
    green:  { label: '–ó–µ–ª—ë–Ω–∞—è', tapMult: 3, flappyMult: 3.0, css: 'green' }
  };
  const PRICE_RED = 40;
  const PRICE_GREEN = 100;

  // ---------- STATE ----------
  let balance = Number(localStorage.getItem(K_BAL) || 0);
  let taps = Number(localStorage.getItem(K_TAPS) || 0);
  let stars = Number(localStorage.getItem(K_STARS) || 0);

  let ownRed = (localStorage.getItem(K_OWN_RED) === '1');
  let ownGreen = (localStorage.getItem(K_OWN_GREEN) === '1');

  let skinKey = localStorage.getItem(K_SKIN) || 'normal';
  if (!SKINS[skinKey]) skinKey = 'normal';

  let energy = Number(localStorage.getItem(K_EN));
  if (!Number.isFinite(energy)) energy = ENERGY_MAX;

  // ---------- ELEMENTS ----------
  const balanceEl = document.getElementById('balance');
  const tapsEl = document.getElementById('taps');
  const starsEl = document.getElementById('stars');
  const stars2El = document.getElementById('stars2');
  const skinLabelEl = document.getElementById('skinLabel');

  const duckBtn = document.getElementById('duckBtn');
  const duckImg = document.getElementById('duckImg');
  const arena = document.getElementById('arena');

  const energyText = document.getElementById('energyText');
  const energyMaxText = document.getElementById('energyMaxText');
  const costText = document.getElementById('costText');
  const regenText = document.getElementById('regenText');
  const regenSecText = document.getElementById('regenSecText');
  const energyBar = document.getElementById('energyBar');
  const energyHint = document.getElementById('energyHint');

  // rub
  const rubBack = document.getElementById('rubBack');
  const openRub = document.getElementById('openRub');
  const closeRub = document.getElementById('closeRub');
  const calcRub = document.getElementById('calcRub');
  const rubPoints = document.getElementById('rubPoints');
  const rubSum = document.getElementById('rubSum');

  // skins modal
  const skinsBack = document.getElementById('skinsBack');
  const openSkins = document.getElementById('openSkins');
  const closeSkins = document.getElementById('closeSkins');
  const buyRed = document.getElementById('buyRed');
  const buyGreen = document.getElementById('buyGreen');
  const equipRed = document.getElementById('equipRed');
  const equipGreen = document.getElementById('equipGreen');
  const howBuyStars = document.getElementById('howBuyStars');
  const skinsMsg = document.getElementById('skinsMsg');

  // flappy
  const flBack = document.getElementById('flBack');
  const openFlappy = document.getElementById('openFlappy');
  const closeFlappy = document.getElementById('closeFlappy');
  const startFlappyBtn = document.getElementById('startFlappy');
  const stakeInp = document.getElementById('stakeInp');
  const stakeNowEl = document.getElementById('stakeNow');
  const scoreEl = document.getElementById('score');
  const statusEl = document.getElementById('status');
  const flMsg = document.getElementById('flMsg');
  const restartBtn = document.getElementById('restartBtn');
  const flMultLabel = document.getElementById('flMultLabel');

  // ---------- HELPERS ----------
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  function saveAll(){
    localStorage.setItem(K_BAL, String(balance));
    localStorage.setItem(K_TAPS, String(taps));
    localStorage.setItem(K_STARS, String(stars));
    localStorage.setItem(K_SKIN, String(skinKey));
    localStorage.setItem(K_OWN_RED, ownRed ? '1' : '0');
    localStorage.setItem(K_OWN_GREEN, ownGreen ? '1' : '0');
    localStorage.setItem(K_EN, String(energy));
  }

  function currentSkin(){ return SKINS[skinKey] || SKINS.normal; }

  function renderTop(){
    balanceEl.textContent = balance;
    tapsEl.textContent = taps;
    starsEl.textContent = stars;
    stars2El.textContent = stars;
    skinLabelEl.textContent = currentSkin().label;

    // duck skin style
    duckImg.classList.remove('red','green');
    if (currentSkin().css) duckImg.classList.add(currentSkin().css);
  }

  function setEnergyBar(){
    energy = clamp(energy, 0, ENERGY_MAX);
    const pct = (energy / ENERGY_MAX) * 100;
    energyBar.style.width = pct + '%';
    if (pct > 55) energyBar.style.background = 'var(--ok)';
    else if (pct > 20) energyBar.style.background = 'var(--warn)';
    else energyBar.style.background = 'var(--bad)';

    duckBtn.disabled = (energy < CLICK_COST);
    energyHint.textContent = (energy < CLICK_COST) ? '–≠–Ω–µ—Ä–≥–∏—è –∫–æ–Ω—á–∏–ª–∞—Å—å üò¥ –ü–æ–¥–æ–∂–¥–∏.' : '–ñ–º–∏ –Ω–∞ —É—Ç–∫—É üôÇ';
  }

  function renderEnergy(){
    energyText.textContent = energy;
    energyMaxText.textContent = ENERGY_MAX;
    costText.textContent = CLICK_COST;
    regenText.textContent = REGEN_AMOUNT;
    regenSecText.textContent = Math.round(REGEN_EVERY_MS/1000);
    setEnergyBar();
  }

  function popDuck(){
    duckImg.classList.remove('pop');
    void duckImg.offsetWidth;
    duckImg.classList.add('pop');
  }

  function bubble(clientX, clientY){
    const b = document.createElement('div');
    b.className = 'bubble';
    const rect = arena.getBoundingClientRect();
    b.style.left = (clientX - rect.left) + 'px';
    b.style.top  = (clientY - rect.top) + 'px';
    const size = 10 + Math.random()*16;
    b.style.width = b.style.height = size + 'px';
    arena.appendChild(b);
    setTimeout(()=> b.remove(), 900);
  }

  // ---------- CLICKER ----------
  duckBtn.addEventListener('click', (e)=>{
    if (energy < CLICK_COST) return;

    energy -= CLICK_COST;

    taps += 1;
    balance += currentSkin().tapMult; // –º–Ω–æ–∂–∏—Ç–µ–ª—å —Å–∫–∏–Ω–∞
    saveAll();
    renderTop();
    renderEnergy();
    popDuck();
    bubble(e.clientX, e.clientY);
  }, {passive:true});

  // regen
  setInterval(()=>{
    if (energy < ENERGY_MAX){
      energy = clamp(energy + REGEN_AMOUNT, 0, ENERGY_MAX);
      saveAll();
      renderEnergy();
    }
  }, REGEN_EVERY_MS);

  // ---------- RUB MODAL ----------
  function updateRub(){
    rubPoints.value = String(balance);
    rubSum.value = (balance * RUB_PER_POINT).toFixed(2) + ' ‚ÇΩ';
  }
  openRub.addEventListener('click', ()=>{ updateRub(); rubBack.classList.add('show'); });
  closeRub.addEventListener('click', ()=> rubBack.classList.remove('show'));
  rubBack.addEventListener('click', (e)=>{ if (e.target === rubBack) rubBack.classList.remove('show'); });
  calcRub.addEventListener('click', updateRub);

  // ---------- SKINS MODAL ----------
  function setSkinsMsg(text, ok){
    skinsMsg.className = 'msg ' + (ok ? 'good' : (ok===false ? 'bad' : ''));
    skinsMsg.textContent = text || '';
  }

  function refreshSkinButtons(){
    // buy buttons
    buyRed.disabled = ownRed || (stars < PRICE_RED);
    buyGreen.disabled = ownGreen || (stars < PRICE_GREEN);

    // equip
    equipRed.disabled = !ownRed;
    equipGreen.disabled = !ownGreen;

    // show current multiplier in flappy label too
    flMultLabel.textContent = 'x' + currentSkin().flappyMult;
  }

  openSkins.addEventListener('click', ()=>{
    setSkinsMsg('', null);
    renderTop();
    refreshSkinButtons();
    skinsBack.classList.add('show');
  });
  closeSkins.addEventListener('click', ()=> skinsBack.classList.remove('show'));
  skinsBack.addEventListener('click', (e)=>{ if (e.target === skinsBack) skinsBack.classList.remove('show'); });

  function buySkin(which){
    if (which === 'red'){
      if (ownRed) return setSkinsMsg('–ö—Ä–∞—Å–Ω–∞—è —É–∂–µ –∫—É–ø–ª–µ–Ω–∞.', true);
      if (stars < PRICE_RED) return setSkinsMsg('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚≠ê.', false);
      stars -= PRICE_RED; ownRed = true; skinKey = 'red';
      saveAll(); renderTop(); refreshSkinButtons();
      setSkinsMsg('–ö—É–ø–ª–µ–Ω–æ! –ö—Ä–∞—Å–Ω–∞—è –Ω–∞–¥–µ—Ç–∞.', true);
    }
    if (which === 'green'){
      if (ownGreen) return setSkinsMsg('–ó–µ–ª—ë–Ω–∞—è —É–∂–µ –∫—É–ø–ª–µ–Ω–∞.', true);
      if (stars < PRICE_GREEN) return setSkinsMsg('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç ‚≠ê.', false);
      stars -= PRICE_GREEN; ownGreen = true; skinKey = 'green';
      saveAll(); renderTop(); refreshSkinButtons();
      setSkinsMsg('–ö—É–ø–ª–µ–Ω–æ! –ó–µ–ª—ë–Ω–∞—è –Ω–∞–¥–µ—Ç–∞.', true);
    }
  }

  buyRed.addEventListener('click', ()=> buySkin('red'));
  buyGreen.addEventListener('click', ()=> buySkin('green'));

  equipRed.addEventListener('click', ()=>{
    if (!ownRed) return;
    skinKey = 'red';
    saveAll(); renderTop(); refreshSkinButtons();
    setSkinsMsg('–ö—Ä–∞—Å–Ω–∞—è –Ω–∞–¥–µ—Ç–∞.', true);
  });
  equipGreen.addEventListener('click', ()=>{
    if (!ownGreen) return;
    skinKey = 'green';
    saveAll(); renderTop(); refreshSkinButtons();
    setSkinsMsg('–ó–µ–ª—ë–Ω–∞—è –Ω–∞–¥–µ—Ç–∞.', true);
  });

  howBuyStars.addEventListener('click', ()=>{
    alert('–†–µ–∞–ª—å–Ω—É—é –ø–æ–∫—É–ø–∫—É ‚≠ê —á–µ—Ä–µ–∑ Telegram Stars –ø–æ–¥–∫–ª—é—á–∞—é—Ç –≤ –±–æ—Ç–µ (—Å–µ—Ä–≤–µ—Ä). –°–µ–π—á–∞—Å —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞.');
  });

  // ---------- FLAPPY MODAL ----------
  openFlappy.addEventListener('click', ()=>{
    flBack.classList.add('show');
    syncUI();
    draw();
  });
  closeFlappy.addEventListener('click', ()=> flBack.classList.remove('show'));
  flBack.addEventListener('click', (e)=>{ if (e.target === flBack) flBack.classList.remove('show'); });

  // ---------- FLAPPY GAME (–∫–∞–∫ —Ä–∞–Ω—å—à–µ, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ –ª–µ–≥—á–µ) ----------
  const cv = document.getElementById('cv');
  const ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height;

  const TARGET = 40;

  // —Å–ª–µ–≥–∫–∞ –ª–µ–≥—á–µ (–Ω–µ ‚Äú–∏–∑–∏‚Äù)
  const GRAV = 0.44;
  const FLAP = -7.55;
  const SPEED = 2.50;
  const GAP = 165;
  const PIPE_W = 64;
  const SPAWN_EVERY = 100;

  let state = 'idle'; // idle, play, over, win
  let stake = 0;
  let score = 0;

  const duck = { x: 90, y: H/2, vy: 0, r: 16 };
  const pipes = [];
  let spawnTimer = 0;

  function setFlMsg(text, kind){
    flMsg.className = 'msg ' + (kind || '');
    flMsg.innerHTML = text || '';
  }

  function syncUI(){
    stakeNowEl.textContent = stake;
    scoreEl.textContent = score;
    statusEl.textContent =
      state==='idle' ? '–Ω–µ –∏–≥—Ä–∞–µ–º' :
      state==='play' ? '–∏–≥—Ä–∞' :
      state==='win' ? '–ø–æ–±–µ–¥–∞' : '–ø—Ä–æ–∏–≥—Ä–∞–ª';
    flMultLabel.textContent = 'x' + currentSkin().flappyMult;
    renderTop();
  }

  function resetRound(toIdle=true){
    score = 0;
    duck.x = 90; duck.y = H/2; duck.vy = 0;
    pipes.length = 0;
    spawnTimer = 0;
    state = toIdle ? 'idle' : 'play';
    setFlMsg('', '');
    syncUI();
  }

  function addPipe(){
    const minTop = 70;
    const maxTop = H - 140 - GAP;
    const topH = Math.floor(minTop + Math.random()*(maxTop - minTop));
    pipes.push({ x: W + 20, topH, passed: false });
  }

  function flap(){
    if (state !== 'play') return;
    duck.vy = FLAP;
  }

  function hitPipe(p){
    const dx1 = duck.x - duck.r, dx2 = duck.x + duck.r;
    const dy1 = duck.y - duck.r, dy2 = duck.y + duck.r;
    const px1 = p.x, px2 = p.x + PIPE_W;
    const topY2 = p.topH;
    const botY1 = p.topH + GAP;

    const xOverlap = !(dx2 < px1 || dx1 > px2);
    if (!xOverlap) return false;
    return (dy1 < topY2) || (dy2 > botY1);
  }

  function win(){
    if (state !== 'play') return;
    state = 'win';
    const mult = currentSkin().flappyMult;
    const payout = Math.round(stake * mult); // –≤—ã–ø–ª–∞—Ç–∞
    balance += payout;
    saveAll();
    setFlMsg(`‚úÖ –ü–æ–±–µ–¥–∞! –í—ã–∏–≥—Ä—ã—à: <b>${stake}</b> √ó <b>${mult}</b> = <b>${payout}</b>`, 'good');
    syncUI();
  }

  function gameOver(){
    if (state !== 'play') return;
    state = 'over';
    setFlMsg(`‚ùå –ü—Ä–æ–∏–≥—Ä–∞–ª. –°—Ç–∞–≤–∫–∞ <b>${stake}</b> —Å–≥–æ—Ä–µ–ª–∞.`, 'bad');
    syncUI();
  }

  function update(){
    duck.vy += GRAV;
    duck.y += duck.vy;

    if (duck.y > H - 30){ duck.y = H - 30; gameOver(); }
    if (duck.y < 10){ duck.y = 10; duck.vy = 0; }

    spawnTimer += 1;
    if (spawnTimer > SPAWN_EVERY){
      spawnTimer = 0;
      addPipe();
    }

    for (const p of pipes){
      p.x -= SPEED;

      if (!p.passed && p.x + PIPE_W < duck.x){
        p.passed = true;
        score += 1;
        if (score >= TARGET) win();
      }
      if (hitPipe(p)) gameOver();
    }

    while (pipes.length && pipes[0].x + PIPE_W < -20) pipes.shift();
  }

  function roundRect(x,y,w,h,r,fill,stroke){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
    if (fill) ctx.fill();
    if (stroke) ctx.stroke();
  }

  function drawDuck(x,y,rot){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(rot);

    ctx.beginPath(); ctx.ellipse(0,0,18,14,0,0,Math.PI*2);
    ctx.fillStyle = '#fbbf24'; ctx.fill();

    ctx.beginPath(); ctx.ellipse(-2,3,10,8,0,0,Math.PI*2);
    ctx.fillStyle = '#fde68a'; ctx.fill();

    ctx.beginPath(); ctx.ellipse(14,-8,10,9,0,0,Math.PI*2);
    ctx.fillStyle = '#fbbf24'; ctx.fill();

    ctx.beginPath(); ctx.ellipse(26,-6,8,4,0,0,Math.PI*2);
    ctx.fillStyle = '#fb923c'; ctx.fill();

    ctx.beginPath(); ctx.arc(16,-10,2.2,0,Math.PI*2);
    ctx.fillStyle = '#0f172a'; ctx.fill();

    ctx.restore();
  }

  function drawBackground(){
    ctx.clearRect(0,0,W,H);
    const g = ctx.createLinearGradient(0,0,0,H);
    g.addColorStop(0,'#93c5fd');
    g.addColorStop(1,'#bae6fd');
    ctx.fillStyle = g;
    ctx.fillRect(0,0,W,H);

    ctx.fillStyle = 'rgba(255,255,255,.55)';
    ctx.beginPath();
    ctx.moveTo(0,H-90);
    ctx.quadraticCurveTo(W*0.25,H-140,W*0.5,H-105);
    ctx.quadraticCurveTo(W*0.75,H-70,W,H-115);
    ctx.lineTo(W,H); ctx.lineTo(0,H);
    ctx.closePath(); ctx.fill();

    ctx.fillStyle = 'rgba(15,23,42,.08)';
    ctx.fillRect(0,H-28,W,28);
  }

  function drawPipes(){
    for (const p of pipes){
      ctx.fillStyle = 'rgba(15,23,42,.18)';
      ctx.strokeStyle = 'rgba(15,23,42,.20)';
      ctx.lineWidth = 2;

      ctx.fillRect(p.x, 0, PIPE_W, p.topH);
      ctx.strokeRect(p.x, 0, PIPE_W, p.topH);

      const by = p.topH + GAP;
      ctx.fillRect(p.x, by, PIPE_W, H - by - 28);
      ctx.strokeRect(p.x, by, PIPE_W, H - by - 28);
    }
  }

  function drawOverlay(text){
    ctx.fillStyle = 'rgba(255,255,255,.80)';
    ctx.strokeStyle = 'rgba(15,23,42,.10)';
    ctx.lineWidth = 2;
    const bw = 310, bh = 90;
    const bx = (W-bw)/2, by = 82;
    roundRect(bx,by,bw,bh,18,true,true);

    ctx.fillStyle = '#0f172a';
    ctx.font = '1000 16px system-ui';
    ctx.textAlign = 'center';
    ctx.fillText(text, W/2, by+40);

    ctx.fillStyle = '#475569';
    ctx.font = '900 13px system-ui';
    ctx.fillText('–¢–∞–ø/–∫–ª–∏–∫/–ø—Ä–æ–±–µ–ª ‚Äî –ø—Ä—ã–∂–æ–∫', W/2, by+64);
  }

  function draw(){
    drawBackground();
    drawPipes();
    const rot = Math.max(-0.6, Math.min(0.8, duck.vy * 0.06));
    drawDuck(duck.x, duck.y, rot);

    ctx.fillStyle = 'rgba(15,23,42,.75)';
    ctx.font = '1000 22px system-ui';
    ctx.textAlign = 'left';
    ctx.fillText(String(score), 14, 34);

    if (state === 'idle') drawOverlay('–í–≤–µ–¥–∏ —Å—Ç–∞–≤–∫—É –∏ –Ω–∞–∂–º–∏ ‚Äú–ò–≥—Ä–∞—Ç—å‚Äù');
    if (state === 'over') drawOverlay('–ü—Ä–æ–∏–≥—Ä–∞–ª. –ù–∞–∂–º–∏ ‚Äú–†–µ—Å—Ç–∞—Ä—Ç‚Äù');
    if (state === 'win') drawOverlay('–ü–æ–±–µ–¥–∞! –ù–∞–∂–º–∏ ‚Äú–†–µ—Å—Ç–∞—Ä—Ç‚Äù');
  }

  function loop(){
    if (state === 'play') update();
    draw();
    requestAnimationFrame(loop);
  }

  cv.addEventListener('pointerdown', (e)=>{ e.preventDefault(); flap(); }, {passive:false});
  window.addEventListener('keydown', (e)=>{
    if (e.code === 'Space'){ e.preventDefault(); flap(); }
  }, {passive:false});

  startFlappyBtn.addEventListener('click', ()=>{
    const s = Math.floor(Number(stakeInp.value));
    if (!Number.isFinite(s) || s <= 0){ setFlMsg('–í–≤–µ–¥–∏—Ç–µ —Å—Ç–∞–≤–∫—É (>0).', 'bad'); return; }
    if (balance < s){ setFlMsg('–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –æ—á–∫–æ–≤ –Ω–∞ —Å—Ç–∞–≤–∫—É.', 'bad'); return; }

    balance -= s; // —Å—Ç–∞–≤–∫–∞ —Å–ø–∏—Å–∞–ª–∞—Å—å
    stake = s;
    saveAll();

    resetRound(false);
    duck.vy = FLAP;
    setFlMsg('–£–¥–∞—á–∏! –¶–µ–ª—å ‚Äî 40.', '');
    syncUI();
  });

  restartBtn.addEventListener('click', ()=> resetRound(true));

  // init
  energy = clamp(energy, 0, ENERGY_MAX);
  renderTop();
  renderEnergy();
  refreshSkinButtons();
  resetRound(true);
  requestAnimationFrame(loop);
</script>
</body>
</html>
